#!/usr/bin/env node

var url = require('url');
var async = require('async');
var workflow = require('../lib/workflow');
var moment = require('moment');

var sendgrid = require('sendgrid')(
    process.env.SENDGRID_USERNAME,
    process.env.SENDGRID_PASSWORD
);

// Starting page at the Vic Supreme Court
var civilCasesPage = url.format({
    protocol: 'http',
    hostname: 'www.supremecourt.vic.gov.au',
    pathname: 'home/forms+fees+and+services/registry+services/list+of+civil+cases/'
});


// Begin processing ...
async.waterfall([
    // dummy function, just to allow parameters to be passed in to the waterfall initially
    // cf. https://github.com/caolan/async/issues/14
    function (callback) {
        callback(null, civilCasesPage);
    },

    // fetch the page containing a link to the court case list, updated daily,
    // and archive it locally so we can review and revise our selectors as necessary
    workflow.fetchCaseListPage,

    // extract the link to a pdf of the latest court cases
    workflow.extractDailyListUrl,

    // download the pdf
    workflow.downloadListPdf,

    // upload the file to S3
    // workflow.uploadListPdf,

    // extract all data from the pdf as an array of strings
    workflow.extractCaseListData,

    // write the json data to file
    workflow.saveCasesJson

], function (err) {
    if (err) {
        console.error('Processing failed:', err);
        process.exit(1);
    }
    else {
        sendgrid.send({
            to:      'michaelallan@optushome.com.au',
            from:    'noreply@scheduled-scraper.herokuapp.com',
            subject: 'Scrape results for ' + moment().format('LLL'),
            text:    'All new Vic Supreme Court cases scraped and loaded'
        }, function (err, json) {
            if (err) console.error('Sendgrid error:', err);
            process.exit(0);
        });
    }
});
